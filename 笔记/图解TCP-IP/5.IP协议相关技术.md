---
title: 5.IP协议相关技术.md
date: 2021-08-04 17:31:30
tags: []
categories:
- 技术博客
- 原创
---

## DNS
每一个连接到互联网上的计算机都有唯一的IP地址，并基于这个IP地址进行通信。然后IP地址有很多不方便的地方，不好记忆。

因此就产生了一个叫做DNS（Domain Name System）的系统，用于解析域名与IP的对象关系。

在应用中，当用户输入主机名（域名）时，DNS会自动检索那个注册了主机名和IP地址的数据库，并迅速定位对应的IP地址。

域名是为了识别主机名称和组织机构名称的一种具有分层的名称。

### 域名的构成
域名是指为了识别主机名称和组织机构名称的一种**有分层**的名称。域名由几个英文字母，由点号(.)连接。

在启用域名之前，单凭主机名还无法完全管理IP地址，因为在不同的组织机构中，不允许有同名的主机。然而，当出现了带有层次结构的域名之后，每一个组织就可以自由的为主机命名了。

> 很长时间以来，域名都是以ASCII字符标识，然而现在也开始逐渐开始使用中文等众多国家的文字标识。

域名服务器是指管理域名的主机和相应的软件，它可以管理相关分层的域的相关信息。

![](https://img-vnote-1251075307.cos.ap-beijing.myqcloud.com/1628996448_20210805085051388_40530579.png)


- 各个域的分层上都设有各自的域名服务器
- 各层域名服务器都了解该层以下分层中所有域名服务器的IP地址。因此他们从根服务器开始呈现树状结构相互连接
- 由于所有域名服务器都了解根域名服务器的IP地址，所以若从根开始按照顺序追踪，可以访问世界上所有域名服务器的地址

根部所设置的域名服务器叫做**根域名服务器**。它对DNS的数据检索功能起着至关重要的作用。根域名服务器上注册着根以下第一层服务器的IP地址。

类似的，在根域名服务器以下第一层服务器上注册着再往下一层的域名服务器的地址。根据每个域名服务器所管理的域名，如果下面再没有其他分层，就可以自由的指定主机名或子网名称。

想要修改某一层的域名或重新设置域名服务器的IP地址，就要在其上层的域名服务器中进行追加或修改。

为了提高容灾能力，一般会设置至少两个以上的域名服务器，一旦第一个域名服务器无法提供查询服务，就会自动转到第二个，第三个域名服务器进行查询。

所有的域名服务器都会注册根域名服务器的IP地址。因为DNS根据IP地址进行检索时，需要从根域名服务器开始按顺序查找。

![DNS查询过程示例](https://img-vnote-1251075307.cos.ap-beijing.myqcloud.com/1628996449_20210805090205439_445125154.png)

## ARP 
ARP(Address Resolution Protocol)是以目标IP地址为线索，用来定位下一个应该接收数据包的网络设备对应的MAC地址的协议。

如果目标主机不在同一个链路上，可以通过ARP查找下一跳路由器的MAC地址。**不过ARP只适用于IPv4，不适用于IPv6**

### ARP的工作机制
ARP通过ARP请求和ARP响应确定目标的MAC地址。

![](https://img-vnote-1251075307.cos.ap-beijing.myqcloud.com/1628996450_20210805090629279_1532920777.png)

主机A要获得主机B的MAC地址，起初要通过 **`广播`** 发送一个ARP请求包，这个包中包含了其想要了解的MAC地址的主机IP地址。
广播可以被 **同一链路** 内的所有主机或路由器接收，因此ARP也就会被同一链路内所有主机和路由器解析，如果ARP主机包中的目标IP地址与自己的IP地址相同，那么这个节点就会将自己的MAC地址塞入ARP响应包返回给主机A。

![ARP数据包格式](https://img-vnote-1251075307.cos.ap-beijing.myqcloud.com/1628996450_20210805091454448_438185980.png)

> ARP请求与响应都发生在同一链路内。

如果每发生一次IP数据包都要进行ARP请求以确定MAC地址，那将会造成很多不必要的流量。一般来说，发送过一次IP数据包的主机，继续发送多次IP数据包的可能性会比较高。因此通常会将获取到的MAC地址缓存一段时间。

不过MAC地址的缓存是有一定期限的。超过这个期限，缓存内容将会被清除。

### RARP
RARP是将ARP反过来，从MAC地址定位IP地址的一种协议。

平常我们通过个人电脑设置IP地址，也可以通过DHCP自动获取IP地址。但有些嵌入式设备，无法通过DHCP获取IP地址，此时就用RARP。

需要先架设一台RARP服务器，从而在这个服务器上注册MAC地址和IP地址的绑定。然后将这个设备接入到网络，启动的那一刻，设备会发送一条“我的MAC地址是*****，请告诉我，我的IP地址是多少”的RARP请求。RARP服务器接到这个请求后返回类似于“MAC地址为*****的设备，IP地址为*****”的响应给设备，设备根据这个响应设置自己的IP地址。


## ICMP
ICMP的主要功能包括，确认IP包是否成功送达目标地址，通知在发送过程当中IP包被废弃的具体原因，改善网络设置等。

在IP通信过程中，如果某个包由于某种原因未能到达目标地址，那么这个具体的原因将由ICMP负责通知。

ICMP通知消息会使用IP进行发送。

ICMP的消息大致分为两类：一类是通知出错原因的错误消息。另一类是用于诊断的查询消息。

### 主要的ICMP消息
#### ICMP目标不可达消息
#### ICMP重定向消息
#### ICMP超时消息
#### ICMP回送消息

## DHCP
为了实现自动设置IP，统一管理IP地址分配，就产生了DHCP协议。
![](https://img-vnote-1251075307.cos.ap-beijing.myqcloud.com/1629005586_20210815122336546_1214883969.png)

### DHCP的工作机制
![](https://img-vnote-1251075307.cos.ap-beijing.myqcloud.com/1629005587_20210815122535341_180635323.png)

为了避免一台DHCP服务器遇到故障，将导致无法自动分配IP地址，一般会架设两台或两台以上的DHCP服务器。但这样也会导致几处分配的IP 地址相互冲突。

### DHCP中继代理
家庭网络大多数只有一个以太网的网段，与其连接的主机数不会太多，因此只需要一台DHCP服务器即可满足地址分配任务。大多数情况下，都由路由器充当这个DHCP的角色。

但在一些大型网络，比如公司或学校中，由于接入的机器数目庞大，需要将DHCP统一管理，可以使用DHCP中继代理来实现。

![](https://img-vnote-1251075307.cos.ap-beijing.myqcloud.com/1629005587_20210815123035102_664069713.png)

客户端会向DHCP中继代理发送DHCP请求包，而DHCP中继代理在收到这个广播包以后再以单播的形式发送给DHCP服务器。服务器收到该包以后再向DHCP中继代理返回应答，并由中继代理将此包转发给客户端。由此，DHCP服务器即使不在同一个链路上也可以实现统一分配和管理IP地址。


## NAT
NAT是用于在本地网络中使用私有地址，在连接互联网时转而使用全局IP地址的技术。
除转换IP地址以外，还出现了TCP，UDP端口号的NAPT技术，由此可以实现用一个全局IP地址与多个主机的通信。

### NAT的工作机制
![](https://img-vnote-1251075307.cos.ap-beijing.myqcloud.com/1629005587_20210815124619901_1968201101.png)

### NAT的潜在问题
1. 无法从NAT的外部向内部服务建立连接
2. 转换表的生成与转换操作都会产生一定的开销
3. 通信过程中一旦NAT遇到异常需要重启，所有的TCP连接都将被重置
4. 即使备置两台NAT做容灾备份，TCP连接还是会断开

## IP隧道
![](https://img-vnote-1251075307.cos.ap-beijing.myqcloud.com/1629170976_20210817112501389_611141234.png)
在如图所示的网络环境中，网络A，B使用Ipv6,而网络C使用IPv4，这就导致网络A，B之间无法直接通信。
为了能让他们通信，这时得采取IP隧道的功能。

IP隧道中可以将那些从网络A发过来的IPv6的包统和为一个数据包，再为之追加一个IPv4的首部以后转发给网络C。

一般情况下，紧接着IP首部的是TCP或UDP的首部，然而现在的应用当中，IP首部后面还是IP首部，或者IP首部后面是IPv6的首部等情况与日俱增，这种在网络层的首部后面还是网络层首部的通信方法就叫“IP隧道”。

![](https://img-vnote-1251075307.cos.ap-beijing.myqcloud.com/1629170977_20210817112907737_36436237.png)

